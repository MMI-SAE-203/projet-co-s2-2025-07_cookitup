---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Mon Profil | Cookit-UP">
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- √âtat de chargement -->
        <div id="loadingState" class="text-center py-16">
            <div class="text-4xl mb-4"></div>
            <h2 class="text-xl font-bold mb-2">Chargement du profil...</h2>
        </div>

        <!-- √âtat non connect√© -->
        <div
            id="notLoggedInState"
            class="text-center py-16 bg-gray-50 rounded-lg hidden"
        >
            <div class="text-6xl mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">Acc√®s restreint</h2>
            <p class="text-gray-600 mb-6">
                Vous devez √™tre connect√© pour acc√©der √† votre profil.
            </p>
            <a
                href="/connexion"
                class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg transition"
            >
                Se connecter
            </a>
        </div>

        <!-- Contenu principal -->
        <div id="mainContent" class="hidden">
            <!-- En-t√™te du profil -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <div
                    class="flex flex-col md:flex-row items-center md:items-start gap-6"
                >
                    <!-- Photo de profil -->
                    <div class="relative">
                        <div
                            class="w-32 h-32 rounded-full overflow-hidden bg-gray-200 border-4 border-white shadow-lg"
                        >
                            <img
                                id="profileAvatar"
                                src="/placeholder.svg"
                                alt="Photo de profil"
                                class="w-full h-full object-cover"
                            />
                        </div>
                        <button
                            id="changeAvatarBtn"
                            class="absolute bottom-0 right-0 bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full shadow-lg transition"
                            title="Changer la photo"
                        >
                            üì∑
                        </button>
                        <input
                            type="file"
                            id="avatarInput"
                            accept="image/*"
                            class="hidden"
                        />
                    </div>

                    <!-- Informations utilisateur -->
                    <div class="flex-1 text-center md:text-left">
                        <h1 id="userName" class="text-3xl font-bold mb-2">
                            Chargement...
                        </h1>
                        <p id="userEmail" class="text-gray-600 mb-4">
                            email@example.com
                        </p>

                        <!-- Statut Cookup -->
                        <div id="cookupStatus" class="mb-4">
                            <!-- Sera rempli dynamiquement -->
                        </div>

                        <!-- Statistiques -->
                        <div
                            class="flex justify-center md:justify-start gap-6 text-sm"
                        >
                            <div class="text-center">
                                <div
                                    id="commentCount"
                                    class="text-2xl font-bold text-yellow-500"
                                >
                                    0
                                </div>
                                <div class="text-gray-600">Commentaires</div>
                            </div>
                            <div class="text-center">
                                <div
                                    id="favoriteCount"
                                    class="text-2xl font-bold text-red-500"
                                >
                                    0
                                </div>
                                <div class="text-gray-600">Favoris</div>
                            </div>
                            <div class="text-center">
                                <div
                                    class="text-2xl font-bold text-green-500"
                                    id="memberSince"
                                >
                                    2024
                                </div>
                                <div class="text-gray-600">Membre depuis</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call to Action Cookup Pass -->
            <div
                id="cookupCTA"
                class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg shadow-lg p-8 mb-8 text-white hidden"
            >
                <div
                    class="flex flex-col md:flex-row items-center justify-between"
                >
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-2xl font-bold mb-2">
                            D√©couvrez le Pass Cookup
                        </h2>
                        <p class="text-yellow-100">
                            Acc√©dez √† des recettes exclusives, des cours de
                            cuisine, la gestion de vos pr√©f√©rences alimentaires
                            et bien plus encore !
                        </p>
                        <ul class="text-yellow-100 text-sm mt-2 space-y-1">
                            <li>
                                ‚Ä¢ Gestion personnalis√©e de votre r√©gime
                                alimentaire
                            </li>
                            <li>‚Ä¢ Recettes adapt√©es √† vos pr√©f√©rences</li>
                            <li>‚Ä¢ Cours de cuisine exclusifs</li>
                            <li>‚Ä¢ Contenu premium</li>
                        </ul>
                    </div>
                    <button
                        id="getCookupPass"
                        class="bg-white text-orange-500 font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition whitespace-nowrap"
                    >
                        Obtenir le Pass Cookup
                    </button>
                </div>
            </div>

            <!-- Onglets -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Navigation des onglets -->
                <div class="border-b border-gray-200">
                    <nav class="flex">
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-yellow-500 text-yellow-600 bg-yellow-50"
                            data-tab="profile"
                        >
                            Informations personnelles
                        </button>
                        <button
                            id="regimeTabBtn"
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="regime"
                        >
                            R√©gime alimentaire
                            <span
                                class="ml-1 text-xs bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded-full"
                                >COOKUP</span
                            >
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="comments"
                        >
                            Mes commentaires
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="avis"
                        >
                            Mes avis
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="subscription"
                        >
                            G√©rer l'abonnement
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="security"
                        >
                            S√©curit√©
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="recipes"
                        >
                            Mes recettes
                        </button>
                    </nav>
                </div>

                <!-- Contenu des onglets -->
                <div class="p-8">
                    <!-- Onglet Informations personnelles -->
                    <div id="profileTab" class="tab-content">
                        <h2 class="text-xl font-bold mb-6">
                            Informations personnelles
                        </h2>

                        <form id="profileForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        for="prenom"
                                        class="block text-sm font-medium text-gray-700 mb-2"
                                        >Pr√©nom</label
                                    >
                                    <input
                                        type="text"
                                        id="prenom"
                                        name="prenom"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="nomFamille"
                                        class="block text-sm font-medium text-gray-700 mb-2"
                                        >Nom de famille</label
                                    >
                                    <input
                                        type="text"
                                        id="nomFamille"
                                        name="nomFamille"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    />
                                </div>
                            </div>

                            <div>
                                <label
                                    for="pseudo"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Pseudo</label
                                >
                                <input
                                    type="text"
                                    id="pseudo"
                                    name="pseudo"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <div>
                                <label
                                    for="email"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Email</label
                                >
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <!-- Message d'erreur/succ√®s -->
                            <div id="profileMessage" class="hidden"></div>

                            <div class="flex gap-4">
                                <button
                                    type="submit"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-2 rounded-lg transition"
                                >
                                    Sauvegarder les modifications
                                </button>
                                <button
                                    type="button"
                                    onclick="loadUserProfile()"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold px-6 py-2 rounded-lg transition"
                                >
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Onglet R√©gime alimentaire -->
                    <div id="regimeTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">
                            R√©gime alimentaire
                        </h2>

                        <p class="text-gray-600 mb-6">
                            S√©lectionnez vos pr√©f√©rences alimentaires pour
                            personnaliser vos recommandations de recettes.
                        </p>

                        <!-- V√©rification du pass Cookup -->
                        <div
                            id="regimeAccessDenied"
                            class="text-center py-12 bg-gradient-to-br from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-xl hidden"
                        >
                            <div class="text-6xl mb-4"></div>
                            <h3 class="text-2xl font-bold text-orange-800 mb-3">
                                Fonctionnalit√© r√©serv√©e au Pass Cookup
                            </h3>
                            <p class="text-orange-600 mb-6 max-w-md mx-auto">
                                D√©bloquez la gestion personnalis√©e de vos
                                pr√©f√©rences alimentaires et obtenez des
                                recommandations de recettes adapt√©es √† votre
                                r√©gime.
                            </p>

                            <!-- Aper√ßu des fonctionnalit√©s -->
                            <div
                                class="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-6 text-sm"
                            >
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        V√©g√©tarien
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        V√©gan
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        Sans gluten
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        Halal
                                    </div>
                                </div>
                            </div>

                            <button
                                id="getCookupPassFromRegime"
                                class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold px-8 py-4 rounded-xl hover:from-yellow-500 hover:to-orange-600 transition transform hover:scale-105 shadow-lg"
                            >
                                D√©bloquer avec le Pass Cookup
                            </button>

                            <p class="text-xs text-orange-500 mt-4">
                                Acc√®s imm√©diat √† toutes les fonctionnalit√©s
                                premium
                            </p>
                        </div>

                        <form id="regimeForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- V√©g√©tarien -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="v√©g√©tarien"
                                        class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            V√©g√©tarien
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Pas de viande ni de poisson
                                        </div>
                                    </div>
                                </label>

                                <!-- V√©gan -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="v√©gan"
                                        class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            V√©gan
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Aucun produit d'origine animale
                                        </div>
                                    </div>
                                </label>

                                <!-- Sans gluten -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="sans-gluten"
                                        class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            Sans gluten
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Sans bl√©, orge, seigle
                                        </div>
                                    </div>
                                </label>

                                <!-- Halal -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="halal"
                                        class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            Halal
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Conforme aux prescriptions
                                            islamiques
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- Message d'erreur/succ√®s -->
                            <div id="regimeMessage" class="hidden"></div>

                            <div class="flex gap-4">
                                <button
                                    type="submit"
                                    class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-2 rounded-lg transition"
                                >
                                    Sauvegarder mes pr√©f√©rences
                                </button>
                                <button
                                    type="button"
                                    onclick="loadUserRegimes()"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold px-6 py-2 rounded-lg transition"
                                >
                                    Annuler
                                </button>
                            </div>
                        </form>

                        <!-- Section informative -->
                        <div
                            class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg"
                        >
                            <h3 class="text-lg font-bold text-blue-800 mb-2">
                                Pourquoi indiquer votre r√©gime ?
                            </h3>
                            <ul class="text-blue-700 space-y-1">
                                <li>
                                    ‚Ä¢ Recettes personnalis√©es selon vos
                                    pr√©f√©rences
                                </li>
                                <li>
                                    ‚Ä¢ Filtrage automatique des recettes
                                    incompatibles
                                </li>
                                <li>‚Ä¢ Suggestions d'ingr√©dients adapt√©s</li>
                                <li>‚Ä¢ Meilleure exp√©rience de navigation</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Onglet Commentaires -->
                    <div id="commentsTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">Mes commentaires</h2>

                        <!-- √âtat de chargement des commentaires -->
                        <div id="commentsLoading" class="text-center py-8">
                            <div class="text-2xl mb-2"></div>
                            <p class="text-gray-600">
                                Chargement de vos commentaires...
                            </p>
                        </div>

                        <!-- Liste des commentaires -->
                        <div id="userCommentsList" class="space-y-4 hidden">
                            <!-- Les commentaires seront ajout√©s ici -->
                        </div>

                        <!-- √âtat vide -->
                        <div
                            id="noUserComments"
                            class="text-center py-12 hidden"
                        >
                            <div class="text-6xl mb-4"></div>
                            <h3 class="text-xl font-bold mb-2">
                                Aucun commentaire
                            </h3>
                            <p class="text-gray-600 mb-4">
                                Vous n'avez pas encore laiss√© de commentaires
                                sur nos recettes.
                            </p>
                            <a
                                href="/recette-plat"
                                class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg transition"
                            >
                                D√©couvrir les recettes
                            </a>
                        </div>
                    </div>

                    <!-- Onglet Mes avis -->
                    <div id="avisTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">
                                Mes avis sur le site
                            </h2>
                            <a
                                href="/avis-site"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-4 py-2 rounded-lg transition"
                            >
                                Donner un avis
                            </a>
                        </div>

                        <!-- √âtat de chargement des avis -->
                        <div id="avisLoading" class="text-center py-8">
                            <div class="text-2xl mb-2"></div>
                            <p class="text-gray-600">
                                Chargement de vos avis...
                            </p>
                        </div>

                        <!-- Liste des avis -->
                        <div id="userAvisList" class="space-y-4 hidden">
                            <!-- Les avis seront ajout√©s ici -->
                        </div>

                        <!-- √âtat vide -->
                        <div id="noUserAvis" class="text-center py-12 hidden">
                            <div class="text-6xl mb-4"></div>
                            <h3 class="text-xl font-bold mb-2">
                                Aucun avis donn√©
                            </h3>
                            <p class="text-gray-600 mb-4">
                                Vous n'avez pas encore donn√© votre avis sur
                                Cookit-UP.
                            </p>
                            <a
                                href="/avis-site"
                                class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg transition"
                            >
                                Donner mon avis
                            </a>
                        </div>
                    </div>

                    <!-- Onglet G√©rer l'abonnement -->
                    <div id="subscriptionTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">
                            G√©rer mon abonnement
                        </h2>

                        <!-- √âtat de chargement -->
                        <div id="subscriptionLoading" class="text-center py-8">
                            <div class="text-2xl mb-2"></div>
                            <p class="text-gray-600">
                                Chargement des informations d'abonnement...
                            </p>
                        </div>

                        <!-- Pas d'abonnement -->
                        <div
                            id="noSubscription"
                            class="text-center py-12 bg-gradient-to-br from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-xl hidden"
                        >
                            <div class="text-6xl mb-4"></div>
                            <h3 class="text-2xl font-bold text-orange-800 mb-3">
                                Aucun abonnement actif
                            </h3>
                            <p class="text-orange-600 mb-6 max-w-md mx-auto">
                                Vous n'avez pas encore d'abonnement Pass Cookup.
                                D√©couvrez tous les avantages et souscrivez d√®s
                                maintenant !
                            </p>

                            <!-- Aper√ßu des avantages -->
                            <div
                                class="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-6 text-sm"
                            >
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        Recettes premium
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        Codes promo
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        Planificateur
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1"></div>
                                    <div class="font-medium text-orange-800">
                                        Support prioritaire
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <a
                                    href="/pass-cookup"
                                    class="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold px-8 py-4 rounded-xl hover:from-yellow-500 hover:to-orange-600 transition transform hover:scale-105 shadow-lg"
                                >
                                    D√©couvrir le Pass Cookup
                                </a>
                                <br />
                                <a
                                    href="/abonnement-cookup"
                                    class="inline-block bg-emerald-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-emerald-700 transition"
                                >
                                    S'abonner maintenant
                                </a>
                            </div>

                            <p class="text-xs text-orange-500 mt-4">
                                √Ä partir de 6,99‚Ç¨/mois ‚Ä¢ R√©siliable √† tout
                                moment
                            </p>
                        </div>

                        <!-- Abonnement actif -->
                        <div id="activeSubscription" class="hidden">
                            <!-- Informations de l'abonnement -->
                            <div
                                class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-lg p-6 text-white mb-6"
                            >
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-bold mb-2">
                                            Pass Cookup Actif
                                        </h3>
                                        <p
                                            id="subscriptionType"
                                            class="text-emerald-100"
                                        >
                                            Abonnement mensuel
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <div
                                            class="text-2xl font-bold"
                                            id="subscriptionPrice"
                                        >
                                            6,99‚Ç¨
                                        </div>
                                        <div class="text-emerald-100 text-sm">
                                            par mois
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- D√©tails de l'abonnement -->
                            <div
                                class="bg-white border border-gray-200 rounded-lg p-6 mb-6"
                            >
                                <h4 class="font-semibold text-gray-900 mb-4">
                                    D√©tails de l'abonnement
                                </h4>
                                <div class="grid md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600"
                                            >Date de souscription :</span
                                        >
                                        <span
                                            id="subscriptionStartDate"
                                            class="font-medium ml-2"
                                            >15 janvier 2024</span
                                        >
                                    </div>
                                    <div>
                                        <span class="text-gray-600"
                                            >Prochaine facturation :</span
                                        >
                                        <span
                                            id="nextBillingDate"
                                            class="font-medium ml-2"
                                            >15 f√©vrier 2024</span
                                        >
                                    </div>
                                    <div>
                                        <span class="text-gray-600"
                                            >Statut :</span
                                        >
                                        <span
                                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 ml-2"
                                        >
                                            ‚úÖ Actif
                                        </span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600"
                                            >Renouvellement automatique :</span
                                        >
                                        <span
                                            id="autoRenewal"
                                            class="font-medium ml-2"
                                            >Activ√©</span
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- Avantages inclus -->
                            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                                <h4 class="font-semibold text-gray-900 mb-4">
                                    Vos avantages Pass Cookup
                                </h4>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Acc√®s aux recettes premium</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Codes promo partenaires exclusifs</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Planificateur de menus personnalis√©</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Support client prioritaire</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Gestion des pr√©f√©rences
                                            alimentaires</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Acc√®s √† la carte des partenaires</span
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="space-y-4">
                                <!-- Modifier l'abonnement -->
                                <div
                                    class="bg-blue-50 border border-blue-200 rounded-lg p-4"
                                >
                                    <h5 class="font-medium text-blue-800 mb-2">
                                        Modifier votre abonnement
                                    </h5>
                                    <p class="text-blue-700 text-sm mb-3">
                                        Vous pouvez passer √† l'abonnement annuel
                                        (79,99‚Ç¨/an) et √©conomiser 26% sur votre
                                        facture.
                                    </p>
                                    <button
                                        onclick="upgradeSubscription()"
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition"
                                    >
                                        Passer √† l'abonnement annuel
                                    </button>
                                </div>

                                <!-- R√©silier l'abonnement -->
                                <div
                                    class="bg-red-50 border border-red-200 rounded-lg p-4"
                                >
                                    <h5 class="font-medium text-red-800 mb-2">
                                        R√©silier votre abonnement
                                    </h5>
                                    <p class="text-red-700 text-sm mb-3">
                                        Vous perdrez l'acc√®s √† tous les
                                        avantages du Pass Cookup √† la fin de
                                        votre p√©riode de facturation actuelle.
                                    </p>
                                    <button
                                        onclick="cancelSubscription()"
                                        class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition"
                                    >
                                        R√©silier l'abonnement
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet S√©curit√© -->
                    <div id="securityTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">
                            S√©curit√© du compte
                        </h2>

                        <form id="passwordForm" class="space-y-6">
                            <div>
                                <label
                                    for="currentPassword"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Mot de passe actuel</label
                                >
                                <input
                                    type="password"
                                    id="currentPassword"
                                    name="currentPassword"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <div>
                                <label
                                    for="newPassword"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Nouveau mot de passe</label
                                >
                                <input
                                    type="password"
                                    id="newPassword"
                                    name="newPassword"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <div>
                                <label
                                    for="confirmPassword"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Confirmer le nouveau mot de passe</label
                                >
                                <input
                                    type="password"
                                    id="confirmPassword"
                                    name="confirmPassword"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <!-- Message d'erreur/succ√®s -->
                            <div id="passwordMessage" class="hidden"></div>

                            <button
                                type="submit"
                                class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-2 rounded-lg transition"
                            >
                                Changer le mot de passe
                            </button>
                        </form>

                        <!-- Section suppression de compte -->
                        <div
                            class="mt-12 p-6 bg-red-50 border border-red-200 rounded-lg"
                        >
                            <h3 class="text-lg font-bold text-red-800 mb-2">
                                Zone dangereuse
                            </h3>
                            <p class="text-red-600 mb-4">
                                La suppression de votre compte est irr√©versible.
                            </p>
                            <button
                                onclick="deleteAccount()"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-2 rounded-lg transition"
                            >
                                Supprimer mon compte
                            </button>
                        </div>
                    </div>

                    <!-- Onglet Mes recettes -->
                    <div id="recipesTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Mes recettes</h2>
                            <a
                                href="/creer-recette"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-4 py-2 rounded-lg transition"
                            >
                                Cr√©er une recette
                            </a>
                        </div>

                        <!-- √âtat de chargement des recettes -->
                        <div id="recipesLoading" class="text-center py-8">
                            <div class="text-2xl mb-2"></div>
                            <p class="text-gray-600">
                                Chargement de vos recettes...
                            </p>
                        </div>

                        <!-- Liste des recettes -->
                        <div
                            id="userRecipesList"
                            class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden"
                        >
                            <!-- Les recettes seront ajout√©es ici -->
                        </div>

                        <!-- √âtat vide -->
                        <div
                            id="noUserRecipes"
                            class="text-center py-12 hidden"
                        >
                            <div class="text-6xl mb-4"></div>
                            <h3 class="text-xl font-bold mb-2">
                                Aucune recette publi√©e
                            </h3>
                            <p class="text-gray-600 mb-4">
                                Vous n'avez pas encore cr√©√© de recettes.
                                Partagez vos talents culinaires avec la
                                communaut√© !
                            </p>
                            <a
                                href="/creer-recette"
                                class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg transition"
                            >
                                Cr√©er ma premi√®re recette
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    import PocketBase from "pocketbase";
    import { isLoggedIn, getCurrentUser, logout } from "../js/auth.js";

    // Initialiser PocketBase directement
    const pb = new PocketBase("https://cookit-up.titouan-winkel.fr");

    let currentUser = null;

    document.addEventListener("DOMContentLoaded", async () => {
        await initProfile();
    });

    // Initialiser la page profil
    async function initProfile() {
        const loadingState = document.getElementById("loadingState");
        const notLoggedInState = document.getElementById("notLoggedInState");
        const mainContent = document.getElementById("mainContent");

        try {
            // V√©rifier la connexion
            if (!isLoggedIn()) {
                loadingState.classList.add("hidden");
                notLoggedInState.classList.remove("hidden");
                return;
            }

            currentUser = getCurrentUser();

            // Charger le profil
            await loadUserProfile();
            await loadUserStats();

            // Initialiser les √©v√©nements
            initTabs();
            initAvatarUpload();
            initForms();

            // Afficher le contenu
            loadingState.classList.add("hidden");
            mainContent.classList.remove("hidden");
        } catch (error) {
            console.error("Erreur lors de l'initialisation du profil:", error);
            loadingState.classList.add("hidden");
            showError("Erreur lors du chargement du profil");
        }
    }

    // Charger les informations utilisateur
    async function loadUserProfile() {
        try {
            // R√©cup√©rer les donn√©es utilisateur √† jour
            const user = await pb.collection("users").getOne(currentUser.id);
            currentUser = user;

            // Mettre √† jour l'affichage
            document.getElementById("userName").textContent =
                user.pseudo || "Utilisateur";
            document.getElementById("userEmail").textContent = user.email;

            // Avatar
            const avatarImg = document.getElementById("profileAvatar");
            if (user.avatar) {
                avatarImg.src = `https://cookit-up.titouan-winkel.fr/api/files/users/${user.id}/${user.avatar}`;
            } else {
                avatarImg.src = "/placeholder.svg";
            }

            // Statut Cookup
            const cookupStatus = document.getElementById("cookupStatus");
            const cookupCTA = document.getElementById("cookupCTA");

            // Gestion de l'affichage de l'onglet r√©gime selon le statut Cookup
            const regimeTabBtn = document.getElementById("regimeTabBtn");
            // L'onglet reste toujours visible
            if (regimeTabBtn) {
                regimeTabBtn.classList.remove("hidden");
            }

            if (user.cookup) {
                cookupStatus.innerHTML = `
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-yellow-400 to-orange-500 text-white">
                        ‚≠ê Membre Cookup Pass
                    </div>
                `;
                cookupCTA.classList.add("hidden");
            } else {
                cookupStatus.innerHTML = `
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                        üë§ Membre standard
                    </div>
                `;
                cookupCTA.classList.remove("hidden");
            }

            // Remplir le formulaire
            document.getElementById("prenom").value = user.prenom || "";
            document.getElementById("nomFamille").value = user.nomFamille || "";
            document.getElementById("pseudo").value = user.pseudo || "";
            document.getElementById("email").value = user.email || "";

            // Date de cr√©ation
            const memberSince = new Date(user.created).getFullYear();
            document.getElementById("memberSince").textContent = memberSince;

            // Charger les r√©gimes de l'utilisateur
            await loadUserRegimes();
        } catch (error) {
            console.error("Erreur lors du chargement du profil:", error);
            throw error;
        }
    }

    // Charger les statistiques utilisateur
    async function loadUserStats() {
        try {
            // Compter les commentaires
            const comments = await pb.collection("commentaires").getFullList({
                filter: `user = "${currentUser.id}"`,
            });
            document.getElementById("commentCount").textContent =
                comments.length;

            // Compter les favoris
            const favorites = await pb.collection("favoris").getFullList({
                filter: `user = "${currentUser.id}"`,
            });
            document.getElementById("favoriteCount").textContent =
                favorites.length;
        } catch (error) {
            console.error("Erreur lors du chargement des statistiques:", error);
        }
    }

    // Initialiser les onglets
    function initTabs() {
        const tabButtons = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");

        tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const targetTab = button.dataset.tab;

                // D√©sactiver tous les onglets
                tabButtons.forEach((btn) => {
                    btn.classList.remove(
                        "border-yellow-500",
                        "text-yellow-600",
                        "bg-yellow-50",
                    );
                    btn.classList.add("border-transparent", "text-gray-500");
                });

                // Cacher tous les contenus
                tabContents.forEach((content) => {
                    content.classList.add("hidden");
                });

                // Activer l'onglet cliqu√©
                button.classList.remove("border-transparent", "text-gray-500");
                button.classList.add(
                    "border-yellow-500",
                    "text-yellow-600",
                    "bg-yellow-50",
                );

                // Afficher le contenu correspondant
                const targetContent = document.getElementById(
                    targetTab + "Tab",
                );
                if (targetContent) {
                    targetContent.classList.remove("hidden");

                    // V√©rifications sp√©ciales selon l'onglet
                    if (targetTab === "comments") {
                        loadUserComments();
                    } else if (targetTab === "avis") {
                        loadUserAvis();
                    } else if (targetTab === "recipes") {
                        loadUserRecipes();
                    } else if (targetTab === "regime") {
                        // V√©rifier l'acc√®s au r√©gime
                        if (!currentUser?.cookup)
                            if (!currentUser?.cookup) {
                                // V√©rifier l'acc√®s au r√©gime
                                // Masquer le formulaire et afficher le message d'acc√®s refus√©
                                document
                                    .getElementById("regimeForm")
                                    .classList.add("hidden");
                                document
                                    .querySelector("#regimeTab .mt-8")
                                    .classList.add("hidden"); // Section informative
                                document
                                    .getElementById("regimeAccessDenied")
                                    .classList.remove("hidden");
                            } else {
                                // Afficher le formulaire et masquer le message
                                document
                                    .getElementById("regimeForm")
                                    .classList.remove("hidden");
                                document
                                    .querySelector("#regimeTab .mt-8")
                                    .classList.remove("hidden"); // Section informative
                                document
                                    .getElementById("regimeAccessDenied")
                                    .classList.add("hidden");
                            }
                    } else if (targetTab === "subscription") {
                        loadSubscriptionInfo();
                    }
                }
            });
        });
    }

    // Initialiser l'upload d'avatar
    function initAvatarUpload() {
        const changeAvatarBtn = document.getElementById("changeAvatarBtn");
        const avatarInput = document.getElementById("avatarInput");
        const profileAvatar = document.getElementById("profileAvatar");

        changeAvatarBtn.addEventListener("click", () => {
            avatarInput.click();
        });

        avatarInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // V√©rifications
            if (!file.type.startsWith("image/")) {
                showError("Veuillez s√©lectionner une image valide");
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                // 5MB
                showError("L'image ne doit pas d√©passer 5MB");
                return;
            }

            try {
                changeAvatarBtn.textContent = "‚è≥";
                changeAvatarBtn.disabled = true;

                // Cr√©er FormData
                const formData = new FormData();
                formData.append("avatar", file);

                // Mettre √† jour l'avatar
                const updatedUser = await pb
                    .collection("users")
                    .update(currentUser.id, formData);

                // Mettre √† jour l'affichage
                profileAvatar.src = `https://cookit-up.titouan-winkel.fr/api/files/users/${updatedUser.id}/${updatedUser.avatar}`;

                showSuccess("Photo de profil mise √† jour !");

                // D√©clencher l'√©v√©nement pour mettre √† jour le header
                document.dispatchEvent(new CustomEvent("userUpdate"));
            } catch (error) {
                console.error("Erreur lors de l'upload:", error);
                showError("Erreur lors de la mise √† jour de la photo");
            } finally {
                changeAvatarBtn.textContent = "üì∑";
                changeAvatarBtn.disabled = false;
            }
        });
    }

    // Initialiser les formulaires
    function initForms() {
        // Formulaire profil
        const profileForm = document.getElementById("profileForm");
        profileForm.addEventListener("submit", handleProfileUpdate);

        // Formulaire mot de passe
        const passwordForm = document.getElementById("passwordForm");
        passwordForm.addEventListener("submit", handlePasswordChange);

        // CTA Cookup Pass
        const getCookupPass = document.getElementById("getCookupPass");
        getCookupPass?.addEventListener("click", () => {
            window.location.href = "/pass-cookup";
        });

        // Formulaire r√©gime
        const regimeForm = document.getElementById("regimeForm");
        regimeForm.addEventListener("submit", handleRegimeUpdate);

        // CTA Cookup Pass depuis l'onglet r√©gime
        const getCookupPassFromRegime = document.getElementById(
            "getCookupPassFromRegime",
        );
        getCookupPassFromRegime?.addEventListener("click", () => {
            window.location.href = "/pass-cookup";
        });
    }

    // G√©rer la mise √† jour du profil
    async function handleProfileUpdate(e) {
        e.preventDefault();

        const profileMessage = document.getElementById("profileMessage");
        const submitBtn = e.target.querySelector('button[type="submit"]');

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = "‚è≥ Sauvegarde...";

            const formData = new FormData(e.target);
            const updateData = {
                prenom: formData.get("prenom"),
                nomFamille: formData.get("nomFamille"),
                pseudo: formData.get("pseudo"),
                email: formData.get("email"),
            };

            await pb.collection("users").update(currentUser.id, updateData);

            showSuccess("Profil mis √† jour avec succ√®s !", profileMessage);

            // Recharger les donn√©es
            await loadUserProfile();

            // D√©clencher l'√©v√©nement pour mettre √† jour le header
            document.dispatchEvent(new CustomEvent("userUpdate"));
        } catch (error) {
            console.error("Erreur lors de la mise √† jour:", error);
            showError(
                "Erreur lors de la mise √† jour du profil",
                profileMessage,
            );
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Sauvegarder les modifications";
        }
    }

    // G√©rer le changement de mot de passe
    async function handlePasswordChange(e) {
        e.preventDefault();

        const passwordMessage = document.getElementById("passwordMessage");
        const submitBtn = e.target.querySelector('button[type="submit"]');

        try {
            const formData = new FormData(e.target);
            const currentPassword = formData.get("currentPassword");
            const newPassword = formData.get("newPassword");
            const confirmPassword = formData.get("confirmPassword");

            // V√©rifications
            if (!currentPassword || !newPassword || !confirmPassword) {
                throw new Error("Tous les champs sont obligatoires");
            }

            if (newPassword !== confirmPassword) {
                throw new Error(
                    "Les nouveaux mots de passe ne correspondent pas",
                );
            }

            if (newPassword.length < 8) {
                throw new Error(
                    "Le nouveau mot de passe doit contenir au moins 8 caract√®res",
                );
            }

            submitBtn.disabled = true;
            submitBtn.textContent = "‚è≥ Modification...";

            // Changer le mot de passe
            await pb.collection("users").update(currentUser.id, {
                oldPassword: currentPassword,
                password: newPassword,
                passwordConfirm: newPassword,
            });

            showSuccess("Mot de passe modifi√© avec succ√®s !", passwordMessage);

            // R√©initialiser le formulaire
            e.target.reset();
        } catch (error) {
            console.error("Erreur lors du changement de mot de passe:", error);
            showError(
                error.message || "Erreur lors du changement de mot de passe",
                passwordMessage,
            );
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Changer le mot de passe";
        }
    }

    // Charger les commentaires de l'utilisateur
    async function loadUserComments() {
        const commentsLoading = document.getElementById("commentsLoading");
        const userCommentsList = document.getElementById("userCommentsList");
        const noUserComments = document.getElementById("noUserComments");

        try {
            commentsLoading.classList.remove("hidden");
            userCommentsList.classList.add("hidden");
            noUserComments.classList.add("hidden");

            const comments = await pb.collection("commentaires").getFullList({
                filter: `user = "${currentUser.id}"`,
                expand: "recette",
                sort: "-created",
            });

            commentsLoading.classList.add("hidden");

            if (comments.length === 0) {
                noUserComments.classList.remove("hidden");
                return;
            }

            userCommentsList.innerHTML = comments
                .map(createUserCommentHTML)
                .join("");
            userCommentsList.classList.remove("hidden");
        } catch (error) {
            console.error("Erreur lors du chargement des commentaires:", error);
            commentsLoading.classList.add("hidden");
            showError("Erreur lors du chargement des commentaires");
        }
    }

    // Charger les avis de l'utilisateur
    async function loadUserAvis() {
        const avisLoading = document.getElementById("avisLoading");
        const userAvisList = document.getElementById("userAvisList");
        const noUserAvis = document.getElementById("noUserAvis");

        try {
            avisLoading.classList.remove("hidden");
            userAvisList.classList.add("hidden");
            noUserAvis.classList.add("hidden");

            const avis = await pb.collection("avis_site").getFullList({
                filter: `user = "${currentUser.id}"`,
                sort: "-created",
            });

            avisLoading.classList.add("hidden");

            if (avis.length === 0) {
                noUserAvis.classList.remove("hidden");
                return;
            }

            userAvisList.innerHTML = avis.map(createUserAvisHTML).join("");
            userAvisList.classList.remove("hidden");
        } catch (error) {
            console.error("Erreur lors du chargement des avis:", error);
            avisLoading.classList.add("hidden");
            showError("Erreur lors du chargement des avis");
        }
    }

    // Charger les recettes de l'utilisateur
    async function loadUserRecipes() {
        const recipesLoading = document.getElementById("recipesLoading");
        const userRecipesList = document.getElementById("userRecipesList");
        const noUserRecipes = document.getElementById("noUserRecipes");

        try {
            recipesLoading.classList.remove("hidden");
            userRecipesList.classList.add("hidden");
            noUserRecipes.classList.add("hidden");

            const recipes = await pb.collection("recettes").getFullList({
                filter: `user = "${currentUser.id}"`,
                sort: "-created",
            });

            recipesLoading.classList.add("hidden");

            if (recipes.length === 0) {
                noUserRecipes.classList.remove("hidden");
                return;
            }

            userRecipesList.innerHTML = recipes
                .map(createUserRecipeHTML)
                .join("");
            userRecipesList.classList.remove("hidden");
        } catch (error) {
            console.error("Erreur lors du chargement des recettes:", error);
            recipesLoading.classList.add("hidden");
            showError("Erreur lors du chargement des recettes");
        }
    }

    // Cr√©er le HTML d'un commentaire utilisateur
    function createUserCommentHTML(comment) {
        const recette = comment.expand?.recette;
        const recetteName = recette?.nom || "Recette supprim√©e";
        const recetteLink = recette ? `/recette-plat/${recette.id}` : "#";

        const createdDate = new Date(comment.created).toLocaleDateString(
            "fr-FR",
            {
                year: "numeric",
                month: "long",
                day: "numeric",
            },
        );

        const stars = comment.note ? "‚≠ê".repeat(comment.note) : "";

        // G√©n√©rer l'avatar
        let avatarHTML = "";
        if (currentUser?.avatar) {
            const avatarUrl = `https://cookit-up.titouan-winkel.fr/api/files/users/${currentUser.id}/${currentUser.avatar}`;
            avatarHTML = `<img src="${avatarUrl}" alt="Mon avatar" class="w-12 h-12 rounded-full object-cover" />`;
        } else {
            const userName =
                currentUser?.name ||
                `${currentUser?.prenom || ""} ${currentUser?.pseudo || ""}`.trim() ||
                "Utilisateur";
            const userInitials = userName
                .split(" ")
                .map((n) => n[0])
                .join("")
                .toUpperCase()
                .slice(0, 2);
            avatarHTML = `<div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold">${userInitials}</div>`;
        }

        return `
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="flex items-start space-x-4">
                    <!-- Avatar -->
                    ${avatarHTML}
                    
                    <!-- Contenu -->
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg">
                                    <a href="${recetteLink}" class="text-yellow-600 hover:text-yellow-800 transition">
                                        ${recetteName}
                                    </a>
                                </h4>
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <span>${createdDate}</span>
                                    ${stars ? `<span class="text-yellow-500">${stars}</span>` : ""}
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-gray-700 leading-relaxed">${comment.commentaire}</p>
                        
                        <div class="mt-4 flex gap-2">
                            <button onclick="editComment('${comment.id}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button onclick="deleteComment('${comment.id}')" 
                                class="text-red-600 hover:text-red-800 text-sm font-medium">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Cr√©er le HTML d'un avis utilisateur
    function createUserAvisHTML(avis) {
        const createdDate = new Date(avis.created).toLocaleDateString("fr-FR", {
            year: "numeric",
            month: "long",
            day: "numeric",
        });

        return `
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-bold text-lg">Mon avis sur Cookit-UP</h4>
                        <div class="text-sm text-gray-600">${createdDate}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editAvis('${avis.id}')" 
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button onclick="deleteAvis('${avis.id}')" 
                            class="text-red-600 hover:text-red-800 text-sm font-medium">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
                
                <p class="text-gray-700 leading-relaxed">${avis.comment}</p>
            </div>
        `;
    }

    // Cr√©er le HTML d'une recette utilisateur
    function createUserRecipeHTML(recipe) {
        const createdDate = new Date(recipe.created).toLocaleDateString(
            "fr-FR",
            {
                year: "numeric",
                month: "long",
                day: "numeric",
            },
        );

        // Image de la recette
        let imageHTML = "";
        if (recipe.image) {
            const imageUrl = `https://cookit-up.titouan-winkel.fr/api/files/recettes/${recipe.id}/${recipe.image}`;
            imageHTML = `<img src="${imageUrl}" alt="${recipe.nom}" class="w-full h-48 object-cover rounded-lg mb-4" />`;
        } else {
            imageHTML = `<div class="w-full h-48 bg-gray-200 rounded-lg mb-4 flex items-center justify-center text-gray-500">
                <span class="text-4xl">üçΩÔ∏è</span>
            </div>`;
        }

        return `
            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                ${imageHTML}
                
                <div class="p-4">
                    <h4 class="font-bold text-lg mb-2">
                        <a href="/recette-plat/${recipe.id}" class="text-yellow-600 hover:text-yellow-800 transition">
                            ${recipe.nom}
                        </a>
                    </h4>
                    
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">${recipe.description || "Aucune description"}</p>
                    
                    <div class="flex justify-between items-center text-sm text-gray-500 mb-4">
                        <span>‚è±Ô∏è ${recipe.temps_preparation || "N/A"} min</span>
                        <span>üìÖ ${createdDate}</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <a href="/recette-plat/${recipe.id}" 
                            class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white text-center py-2 px-4 rounded-lg text-sm font-medium transition">
                            üëÅÔ∏è Voir
                        </a>
                        <button onclick="editRecipe('${recipe.id}')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button onclick="deleteRecipe('${recipe.id}')" 
                            class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm
                            class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition">
                                üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Charger les r√©gimes de l'utilisateur
    async function loadUserRegimes() {
        try {
            const user = await pb.collection("users").getOne(currentUser.id);
            const regimes = user.regimes || [];

            // D√©cocher toutes les cases
            const checkboxes = document.querySelectorAll(
                'input[name="regime"]',
            );
            checkboxes.forEach((checkbox) => {
                checkbox.checked = regimes.includes(checkbox.value);
            });
        } catch (error) {
            console.error("Erreur lors du chargement des r√©gimes:", error);
        }
    }

    // G√©rer la mise √† jour du r√©gime
    async function handleRegimeUpdate(e) {
        e.preventDefault();

        const regimeMessage = document.getElementById("regimeMessage");
        const submitBtn = e.target.querySelector('button[type="submit"]');

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = "‚è≥ Sauvegarde...";

            const formData = new FormData(e.target);
            const selectedRegimes = formData.getAll("regime");

            await pb.collection("users").update(currentUser.id, {
                regimes: selectedRegimes,
            });

            showSuccess(
                "Pr√©f√©rences alimentaires mises √† jour !",
                regimeMessage,
            );
        } catch (error) {
            console.error("Erreur lors de la mise √† jour des r√©gimes:", error);
            showError(
                "Erreur lors de la mise √† jour des pr√©f√©rences",
                regimeMessage,
            );
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Sauvegarder mes pr√©f√©rences";
        }
    }

    // Charger les informations d'abonnement
    async function loadSubscriptionInfo() {
        const subscriptionLoading = document.getElementById(
            "subscriptionLoading",
        );
        const noSubscription = document.getElementById("noSubscription");
        const activeSubscription =
            document.getElementById("activeSubscription");

        try {
            subscriptionLoading.classList.remove("hidden");
            noSubscription.classList.add("hidden");
            activeSubscription.classList.add("hidden");

            // V√©rifier le statut d'abonnement
            const user = await pb.collection("users").getOne(currentUser.id);

            subscriptionLoading.classList.add("hidden");

            if (!user.cookup) {
                noSubscription.classList.remove("hidden");
            } else {
                // Donn√©es d'abonnement avec les vrais prix
                const subscriptionData = {
                    type: "mensuel",
                    price: "6,99‚Ç¨",
                    startDate: "15 janvier 2024",
                    nextBilling: "15 f√©vrier 2024",
                    status: "actif",
                    autoRenewal: true,
                };

                // Remplir les informations
                document.getElementById("subscriptionType").textContent =
                    subscriptionData.type === "mensuel"
                        ? "Abonnement mensuel"
                        : "Abonnement annuel";
                document.getElementById("subscriptionPrice").textContent =
                    subscriptionData.price;
                document.getElementById("subscriptionStartDate").textContent =
                    subscriptionData.startDate;
                document.getElementById("nextBillingDate").textContent =
                    subscriptionData.nextBilling;
                document.getElementById("autoRenewal").textContent =
                    subscriptionData.autoRenewal ? "Activ√©" : "D√©sactiv√©";

                activeSubscription.classList.remove("hidden");
            }
        } catch (error) {
            console.error("Erreur lors du chargement de l'abonnement:", error);
            subscriptionLoading.classList.add("hidden");
            showError(
                "Erreur lors du chargement des informations d'abonnement",
            );
        }
    }

    // Fonctions globales pour les actions
    window.editComment = function (commentId) {
        // Rediriger vers la recette pour modifier le commentaire
        alert("Fonctionnalit√© de modification en cours de d√©veloppement");
    };

    window.deleteComment = async function (commentId) {
        if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce commentaire ?"))
            return;

        try {
            await pb.collection("commentaires").delete(commentId);
            showSuccess("Commentaire supprim√©");
            loadUserComments(); // Recharger la liste
        } catch (error) {
            console.error("Erreur lors de la suppression:", error);
            showError("Erreur lors de la suppression du commentaire");
        }
    };

    window.editAvis = function (avisId) {
        // Rediriger vers la page d'avis avec l'ID pour modification
        window.location.href = `/avis-site?edit=${avisId}`;
    };

    window.deleteAvis = async function (avisId) {
        if (!confirm("√ätes-vous s√ªr de vouloir supprimer cet avis ?")) return;

        try {
            await pb.collection("avis_site").delete(avisId);
            showSuccess("Avis supprim√©");
            loadUserAvis(); // Recharger la liste
        } catch (error) {
            console.error("Erreur lors de la suppression:", error);
            showError("Erreur lors de la suppression de l'avis");
        }
    };

    window.editRecipe = function (recipeId) {
        // Rediriger vers la page de modification de recette
        alert("Fonctionnalit√© de modification en cours de d√©veloppement");
    };

    window.deleteRecipe = async function (recipeId) {
        if (!confirm("√ätes-vous s√ªr de vouloir supprimer cette recette ?"))
            return;

        try {
            await pb.collection("recettes").delete(recipeId);
            showSuccess("Recette supprim√©e");
            loadUserRecipes(); // Recharger la liste
        } catch (error) {
            console.error("Erreur lors de la suppression:", error);
            showError("Erreur lors de la suppression de la recette");
        }
    };

    window.upgradeSubscription = async function () {
        if (
            !confirm(
                "Passer √† l'abonnement annuel ? Vous √©conomiserez 26% sur votre facture.",
            )
        )
            return;

        try {
            // Simuler la mise √† niveau
            showSuccess("Abonnement mis √† niveau vers l'offre annuelle !");
            setTimeout(() => {
                loadSubscriptionInfo(); // Recharger les infos
            }, 1000);
        } catch (error) {
            console.error("Erreur lors de la mise √† niveau:", error);
            showError("Erreur lors de la mise √† niveau de l'abonnement");
        }
    };

    window.cancelSubscription = async function () {
        const confirmation = prompt(
            'Pour confirmer la r√©siliation, tapez "RESILIER" (en majuscules) :',
        );
        if (confirmation !== "RESILIER") {
            alert("R√©siliation annul√©e");
            return;
        }

        try {
            // Mettre √† jour le statut Cookup de l'utilisateur
            await pb.collection("users").update(currentUser.id, {
                cookup: false,
            });

            showSuccess(
                "Abonnement r√©sili√©. Vous conservez l'acc√®s jusqu'√† la fin de votre p√©riode de facturation.",
            );

            // Recharger le profil pour mettre √† jour l'affichage
            setTimeout(async () => {
                await loadUserProfile();
                loadSubscriptionInfo();

                // D√©clencher l'√©v√©nement pour mettre √† jour le header
                document.dispatchEvent(new CustomEvent("userUpdate"));
            }, 1000);
        } catch (error) {
            console.error("Erreur lors de la r√©siliation:", error);
            showError("Erreur lors de la r√©siliation de l'abonnement");
        }
    };

    window.deleteAccount = async function () {
        const confirmation = prompt(
            'Cette action est irr√©versible. Tapez "SUPPRIMER" pour confirmer :',
        );
        if (confirmation !== "SUPPRIMER") {
            alert("Suppression annul√©e");
            return;
        }

        try {
            await pb.collection("users").delete(currentUser.id);
            logout();
            window.location.href = "/";
        } catch (error) {
            console.error("Erreur lors de la suppression:", error);
            showError("Erreur lors de la suppression du compte");
        }
    };

    // Fonctions utilitaires
    function showSuccess(message, container = null) {
        const messageDiv = container || document.createElement("div");
        if (!container) {
            document.body.appendChild(messageDiv);
            messageDiv.className = "fixed top-4 right-4 z-50";
        }

        messageDiv.innerHTML = `
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                ‚úÖ ${message}
            </div>
        `;
        messageDiv.classList.remove("hidden");

        if (!container) {
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    }

    function showError(message, container = null) {
        const messageDiv = container || document.createElement("div");
        if (!container) {
            document.body.appendChild(messageDiv);
            messageDiv.className = "fixed top-4 right-4 z-50";
        }

        messageDiv.innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                ‚ùå ${message}
            </div>
        `;
        messageDiv.classList.remove("hidden");

        if (!container) {
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    }
</script>
