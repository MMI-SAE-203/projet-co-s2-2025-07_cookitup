---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Mon Profil | Cookit-UP">
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- √âtat de chargement -->
        <div id="loadingState" class="text-center py-16">
            <div class="text-4xl mb-4">‚è≥</div>
            <h2 class="text-xl font-bold mb-2">Chargement du profil...</h2>
        </div>

        <!-- √âtat non connect√© -->
        <div
            id="notLoggedInState"
            class="text-center py-16 bg-gray-50 rounded-lg hidden"
        >
            <div class="text-6xl mb-4">üîí</div>
            <h2 class="text-2xl font-bold mb-2">Acc√®s restreint</h2>
            <p class="text-gray-600 mb-6">
                Vous devez √™tre connect√© pour acc√©der √† votre profil.
            </p>
            <a
                href="/connexion"
                class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg transition"
            >
                Se connecter
            </a>
        </div>

        <!-- Contenu principal -->
        <div id="mainContent" class="hidden">
            <!-- En-t√™te du profil -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <div
                    class="flex flex-col md:flex-row items-center md:items-start gap-6"
                >
                    <!-- Photo de profil -->
                    <div class="relative">
                        <div
                            class="w-32 h-32 rounded-full overflow-hidden bg-gray-200 border-4 border-white shadow-lg"
                        >
                            <img
                                id="profileAvatar"
                                src="/placeholder.svg"
                                alt="Photo de profil"
                                class="w-full h-full object-cover"
                            />
                        </div>
                        <button
                            id="changeAvatarBtn"
                            class="absolute bottom-0 right-0 bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full shadow-lg transition"
                            title="Changer la photo"
                        >
                            üì∑
                        </button>
                        <input
                            type="file"
                            id="avatarInput"
                            accept="image/*"
                            class="hidden"
                        />
                    </div>

                    <!-- Informations utilisateur -->
                    <div class="flex-1 text-center md:text-left">
                        <h1 id="userName" class="text-3xl font-bold mb-2">
                            Chargement...
                        </h1>
                        <p id="userEmail" class="text-gray-600 mb-4">
                            email@example.com
                        </p>

                        <!-- Statut Cookup -->
                        <div id="cookupStatus" class="mb-4">
                            <!-- Sera rempli dynamiquement -->
                        </div>

                        <!-- Statistiques -->
                        <div
                            class="flex justify-center md:justify-start gap-6 text-sm"
                        >
                            <div class="text-center">
                                <div
                                    id="commentCount"
                                    class="text-2xl font-bold text-yellow-500"
                                >
                                    0
                                </div>
                                <div class="text-gray-600">Commentaires</div>
                            </div>
                            <div class="text-center">
                                <div
                                    id="favoriteCount"
                                    class="text-2xl font-bold text-red-500"
                                >
                                    0
                                </div>
                                <div class="text-gray-600">Favoris</div>
                            </div>
                            <div class="text-center">
                                <div
                                    class="text-2xl font-bold text-green-500"
                                    id="memberSince"
                                >
                                    2024
                                </div>
                                <div class="text-gray-600">Membre depuis</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call to Action Cookup Pass -->
            <div
                id="cookupCTA"
                class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg shadow-lg p-8 mb-8 text-white hidden"
            >
                <div
                    class="flex flex-col md:flex-row items-center justify-between"
                >
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-2xl font-bold mb-2">
                            üåü D√©couvrez le Pass Cookup
                        </h2>
                        <p class="text-yellow-100">
                            Acc√©dez √† des recettes exclusives, des cours de
                            cuisine, la gestion de vos pr√©f√©rences alimentaires
                            et bien plus encore !
                        </p>
                        <ul class="text-yellow-100 text-sm mt-2 space-y-1">
                            <li>
                                ‚Ä¢ ü•ó Gestion personnalis√©e de votre r√©gime
                                alimentaire
                            </li>
                            <li>‚Ä¢ üçΩÔ∏è Recettes adapt√©es √† vos pr√©f√©rences</li>
                            <li>‚Ä¢ üë®‚Äçüç≥ Cours de cuisine exclusifs</li>
                            <li>‚Ä¢ ‚≠ê Contenu premium</li>
                        </ul>
                    </div>
                    <button
                        id="getCookupPass"
                        class="bg-white text-orange-500 font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition whitespace-nowrap"
                    >
                        Obtenir le Pass Cookup
                    </button>
                </div>
            </div>

            <!-- Onglets -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Navigation des onglets -->
                <div class="border-b border-gray-200">
                    <nav class="flex">
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-yellow-500 text-yellow-600 bg-yellow-50"
                            data-tab="profile"
                        >
                            üë§ Informations personnelles
                        </button>
                        <button
                            id="regimeTabBtn"
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="regime"
                        >
                            ü•ó R√©gime alimentaire
                            <span
                                class="ml-1 text-xs bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-2 py-1 rounded-full"
                                >COOKUP</span
                            >
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="comments"
                        >
                            üí¨ Mes commentaires
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="avis"
                        >
                            ‚≠ê Mes avis
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="subscription"
                        >
                            üí≥ G√©rer l'abonnement
                        </button>
                        <button
                            class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            data-tab="security"
                        >
                            üîí S√©curit√©
                        </button>
                    </nav>
                </div>

                <!-- Contenu des onglets -->
                <div class="p-8">
                    <!-- Onglet Informations personnelles -->
                    <div id="profileTab" class="tab-content">
                        <h2 class="text-xl font-bold mb-6">
                            Informations personnelles
                        </h2>

                        <form id="profileForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        for="prenom"
                                        class="block text-sm font-medium text-gray-700 mb-2"
                                        >Pr√©nom</label
                                    >
                                    <input
                                        type="text"
                                        id="prenom"
                                        name="prenom"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="nomFamille"
                                        class="block text-sm font-medium text-gray-700 mb-2"
                                        >Nom de famille</label
                                    >
                                    <input
                                        type="text"
                                        id="nomFamille"
                                        name="nomFamille"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    />
                                </div>
                            </div>

                            <div>
                                <label
                                    for="pseudo"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Pseudo</label
                                >
                                <input
                                    type="text"
                                    id="pseudo"
                                    name="pseudo"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <div>
                                <label
                                    for="email"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Email</label
                                >
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <!-- Message d'erreur/succ√®s -->
                            <div id="profileMessage" class="hidden"></div>

                            <div class="flex gap-4">
                                <button
                                    type="submit"
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-2 rounded-lg transition"
                                >
                                    üíæ Sauvegarder les modifications
                                </button>
                                <button
                                    type="button"
                                    onclick="loadUserProfile()"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold px-6 py-2 rounded-lg transition"
                                >
                                    üîÑ Annuler
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Onglet R√©gime alimentaire -->
                    <div id="regimeTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">
                            R√©gime alimentaire
                        </h2>

                        <p class="text-gray-600 mb-6">
                            S√©lectionnez vos pr√©f√©rences alimentaires pour
                            personnaliser vos recommandations de recettes.
                        </p>

                        <!-- V√©rification du pass Cookup -->
                        <div
                            id="regimeAccessDenied"
                            class="text-center py-12 bg-gradient-to-br from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-xl hidden"
                        >
                            <div class="text-6xl mb-4">üîí</div>
                            <h3 class="text-2xl font-bold text-orange-800 mb-3">
                                Fonctionnalit√© r√©serv√©e au Pass Cookup
                            </h3>
                            <p class="text-orange-600 mb-6 max-w-md mx-auto">
                                D√©bloquez la gestion personnalis√©e de vos
                                pr√©f√©rences alimentaires et obtenez des
                                recommandations de recettes adapt√©es √† votre
                                r√©gime.
                            </p>

                            <!-- Aper√ßu des fonctionnalit√©s -->
                            <div
                                class="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-6 text-sm"
                            >
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">üå±</div>
                                    <div class="font-medium text-orange-800">
                                        V√©g√©tarien
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">üåø</div>
                                    <div class="font-medium text-orange-800">
                                        V√©gan
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">üåæ</div>
                                    <div class="font-medium text-orange-800">
                                        Sans gluten
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">‚ò™Ô∏è</div>
                                    <div class="font-medium text-orange-800">
                                        Halal
                                    </div>
                                </div>
                            </div>

                            <button
                                id="getCookupPassFromRegime"
                                class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold px-8 py-4 rounded-xl hover:from-yellow-500 hover:to-orange-600 transition transform hover:scale-105 shadow-lg"
                            >
                                üåü D√©bloquer avec le Pass Cookup
                            </button>

                            <p class="text-xs text-orange-500 mt-4">
                                Acc√®s imm√©diat √† toutes les fonctionnalit√©s
                                premium
                            </p>
                        </div>

                        <form id="regimeForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- V√©g√©tarien -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="v√©g√©tarien"
                                        class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            üå± V√©g√©tarien
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Pas de viande ni de poisson
                                        </div>
                                    </div>
                                </label>

                                <!-- V√©gan -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="v√©gan"
                                        class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            üåø V√©gan
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Aucun produit d'origine animale
                                        </div>
                                    </div>
                                </label>

                                <!-- Sans gluten -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="sans-gluten"
                                        class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            üåæ Sans gluten
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Sans bl√©, orge, seigle
                                        </div>
                                    </div>
                                </label>

                                <!-- Halal -->
                                <label
                                    class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                >
                                    <input
                                        type="checkbox"
                                        name="regime"
                                        value="halal"
                                        class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 focus:ring-2"
                                    />
                                    <div class="ml-3">
                                        <div
                                            class="text-lg font-medium text-gray-900"
                                        >
                                            ‚ò™Ô∏è Halal
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            Conforme aux prescriptions
                                            islamiques
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- Message d'erreur/succ√®s -->
                            <div id="regimeMessage" class="hidden"></div>

                            <div class="flex gap-4">
                                <button
                                    type="submit"
                                    class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-2 rounded-lg transition"
                                >
                                    ü•ó Sauvegarder mes pr√©f√©rences
                                </button>
                                <button
                                    type="button"
                                    onclick="loadUserRegimes()"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold px-6 py-2 rounded-lg transition"
                                >
                                    üîÑ Annuler
                                </button>
                            </div>
                        </form>

                        <!-- Section informative -->
                        <div
                            class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg"
                        >
                            <h3 class="text-lg font-bold text-blue-800 mb-2">
                                üí° Pourquoi indiquer votre r√©gime ?
                            </h3>
                            <ul class="text-blue-700 space-y-1">
                                <li>
                                    ‚Ä¢ Recettes personnalis√©es selon vos
                                    pr√©f√©rences
                                </li>
                                <li>
                                    ‚Ä¢ Filtrage automatique des recettes
                                    incompatibles
                                </li>
                                <li>‚Ä¢ Suggestions d'ingr√©dients adapt√©s</li>
                                <li>‚Ä¢ Meilleure exp√©rience de navigation</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Onglet Commentaires -->
                    <div id="commentsTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">Mes commentaires</h2>

                        <!-- √âtat de chargement des commentaires -->
                        <div id="commentsLoading" class="text-center py-8">
                            <div class="text-2xl mb-2">‚è≥</div>
                            <p class="text-gray-600">
                                Chargement de vos commentaires...
                            </p>
                        </div>

                        <!-- Liste des commentaires -->
                        <div id="userCommentsList" class="space-y-4 hidden">
                            <!-- Les commentaires seront ajout√©s ici -->
                        </div>

                        <!-- √âtat vide -->
                        <div
                            id="noUserComments"
                            class="text-center py-12 hidden"
                        >
                            <div class="text-6xl mb-4">üí≠</div>
                            <h3 class="text-xl font-bold mb-2">
                                Aucun commentaire
                            </h3>
                            <p class="text-gray-600 mb-4">
                                Vous n'avez pas encore laiss√© de commentaires
                                sur nos recettes.
                            </p>
                            <a
                                href="/recette-plat"
                                class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg transition"
                            >
                                D√©couvrir les recettes
                            </a>
                        </div>
                    </div>

                    <!-- Onglet Mes avis -->
                    <div id="avisTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">
                                Mes avis sur le site
                            </h2>
                            <a
                                href="/avis-site"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-4 py-2 rounded-lg transition"
                            >
                                ‚úçÔ∏è Donner un avis
                            </a>
                        </div>

                        <!-- √âtat de chargement des avis -->
                        <div id="avisLoading" class="text-center py-8">
                            <div class="text-2xl mb-2">‚è≥</div>
                            <p class="text-gray-600">
                                Chargement de vos avis...
                            </p>
                        </div>

                        <!-- Liste des avis -->
                        <div id="userAvisList" class="space-y-4 hidden">
                            <!-- Les avis seront ajout√©s ici -->
                        </div>

                        <!-- √âtat vide -->
                        <div id="noUserAvis" class="text-center py-12 hidden">
                            <div class="text-6xl mb-4">‚≠ê</div>
                            <h3 class="text-xl font-bold mb-2">
                                Aucun avis donn√©
                            </h3>
                            <p class="text-gray-600 mb-4">
                                Vous n'avez pas encore donn√© votre avis sur
                                Cookit-UP.
                            </p>
                            <a
                                href="/avis-site"
                                class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg transition"
                            >
                                ‚úçÔ∏è Donner mon avis
                            </a>
                        </div>
                    </div>

                    <!-- Onglet G√©rer l'abonnement -->
                    <div id="subscriptionTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">
                            G√©rer mon abonnement
                        </h2>

                        <!-- √âtat de chargement -->
                        <div id="subscriptionLoading" class="text-center py-8">
                            <div class="text-2xl mb-2">‚è≥</div>
                            <p class="text-gray-600">
                                Chargement des informations d'abonnement...
                            </p>
                        </div>

                        <!-- Pas d'abonnement -->
                        <div
                            id="noSubscription"
                            class="text-center py-12 bg-gradient-to-br from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-xl hidden"
                        >
                            <div class="text-6xl mb-4">üí≥</div>
                            <h3 class="text-2xl font-bold text-orange-800 mb-3">
                                Aucun abonnement actif
                            </h3>
                            <p class="text-orange-600 mb-6 max-w-md mx-auto">
                                Vous n'avez pas encore d'abonnement Pass Cookup.
                                D√©couvrez tous les avantages et souscrivez d√®s
                                maintenant !
                            </p>

                            <!-- Aper√ßu des avantages -->
                            <div
                                class="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-6 text-sm"
                            >
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">üçΩÔ∏è</div>
                                    <div class="font-medium text-orange-800">
                                        Recettes premium
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">üè™</div>
                                    <div class="font-medium text-orange-800">
                                        Codes promo
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">üìÖ</div>
                                    <div class="font-medium text-orange-800">
                                        Planificateur
                                    </div>
                                </div>
                                <div
                                    class="bg-white/50 p-3 rounded-lg border border-orange-100"
                                >
                                    <div class="text-2xl mb-1">üÜò</div>
                                    <div class="font-medium text-orange-800">
                                        Support prioritaire
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <a
                                    href="/pass-cookup"
                                    class="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold px-8 py-4 rounded-xl hover:from-yellow-500 hover:to-orange-600 transition transform hover:scale-105 shadow-lg"
                                >
                                    üåü D√©couvrir le Pass Cookup
                                </a>
                                <br />
                                <a
                                    href="/abonnement-cookup"
                                    class="inline-block bg-emerald-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-emerald-700 transition"
                                >
                                    üí≥ S'abonner maintenant
                                </a>
                            </div>

                            <p class="text-xs text-orange-500 mt-4">
                                √Ä partir de 5,99‚Ç¨/mois ‚Ä¢ R√©siliable √† tout
                                moment
                            </p>
                        </div>

                        <!-- Abonnement actif -->
                        <div id="activeSubscription" class="hidden">
                            <!-- Informations de l'abonnement -->
                            <div
                                class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-lg p-6 text-white mb-6"
                            >
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-bold mb-2">
                                            üåü Pass Cookup Actif
                                        </h3>
                                        <p
                                            id="subscriptionType"
                                            class="text-emerald-100"
                                        >
                                            Abonnement mensuel
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <div
                                            class="text-2xl font-bold"
                                            id="subscriptionPrice"
                                        >
                                            5,99‚Ç¨
                                        </div>
                                        <div class="text-emerald-100 text-sm">
                                            par mois
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- D√©tails de l'abonnement -->
                            <div
                                class="bg-white border border-gray-200 rounded-lg p-6 mb-6"
                            >
                                <h4 class="font-semibold text-gray-900 mb-4">
                                    D√©tails de l'abonnement
                                </h4>
                                <div class="grid md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600"
                                            >Date de souscription :</span
                                        >
                                        <span
                                            id="subscriptionStartDate"
                                            class="font-medium ml-2"
                                            >15 janvier 2024</span
                                        >
                                    </div>
                                    <div>
                                        <span class="text-gray-600"
                                            >Prochaine facturation :</span
                                        >
                                        <span
                                            id="nextBillingDate"
                                            class="font-medium ml-2"
                                            >15 f√©vrier 2024</span
                                        >
                                    </div>
                                    <div>
                                        <span class="text-gray-600"
                                            >Statut :</span
                                        >
                                        <span
                                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 ml-2"
                                        >
                                            ‚úÖ Actif
                                        </span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600"
                                            >Renouvellement automatique :</span
                                        >
                                        <span
                                            id="autoRenewal"
                                            class="font-medium ml-2"
                                            >Activ√©</span
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- Avantages inclus -->
                            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                                <h4 class="font-semibold text-gray-900 mb-4">
                                    Vos avantages Pass Cookup
                                </h4>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Acc√®s aux recettes premium</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Codes promo partenaires exclusifs</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Planificateur de menus personnalis√©</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Support client prioritaire</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Gestion des pr√©f√©rences
                                            alimentaires</span
                                        >
                                    </div>
                                    <div class="flex items-center">
                                        <svg
                                            class="h-5 w-5 text-emerald-500 mr-3"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700"
                                            >Acc√®s √† la carte des partenaires</span
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="space-y-4">
                                <!-- Modifier l'abonnement -->
                                <div
                                    class="bg-blue-50 border border-blue-200 rounded-lg p-4"
                                >
                                    <h5 class="font-medium text-blue-800 mb-2">
                                        üí° Modifier votre abonnement
                                    </h5>
                                    <p class="text-blue-700 text-sm mb-3">
                                        Vous pouvez passer √† l'abonnement annuel
                                        et √©conomiser 26% sur votre facture.
                                    </p>
                                    <button
                                        onclick="upgradeSubscription()"
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition"
                                    >
                                        üìà Passer √† l'abonnement annuel
                                    </button>
                                </div>

                                <!-- R√©silier l'abonnement -->
                                <div
                                    class="bg-red-50 border border-red-200 rounded-lg p-4"
                                >
                                    <h5 class="font-medium text-red-800 mb-2">
                                        ‚ö†Ô∏è R√©silier votre abonnement
                                    </h5>
                                    <p class="text-red-700 text-sm mb-3">
                                        Vous perdrez l'acc√®s √† tous les
                                        avantages du Pass Cookup √† la fin de
                                        votre p√©riode de facturation actuelle.
                                    </p>
                                    <button
                                        onclick="cancelSubscription()"
                                        class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition"
                                    >
                                        üóëÔ∏è R√©silier l'abonnement
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet S√©curit√© -->
                    <div id="securityTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold mb-6">
                            S√©curit√© du compte
                        </h2>

                        <form id="passwordForm" class="space-y-6">
                            <div>
                                <label
                                    for="currentPassword"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Mot de passe actuel</label
                                >
                                <input
                                    type="password"
                                    id="currentPassword"
                                    name="currentPassword"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <div>
                                <label
                                    for="newPassword"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Nouveau mot de passe</label
                                >
                                <input
                                    type="password"
                                    id="newPassword"
                                    name="newPassword"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <div>
                                <label
                                    for="confirmPassword"
                                    class="block text-sm font-medium text-gray-700 mb-2"
                                    >Confirmer le nouveau mot de passe</label
                                >
                                <input
                                    type="password"
                                    id="confirmPassword"
                                    name="confirmPassword"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                />
                            </div>

                            <!-- Message d'erreur/succ√®s -->
                            <div id="passwordMessage" class="hidden"></div>

                            <button
                                type="submit"
                                class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-2 rounded-lg transition"
                            >
                                üîí Changer le mot de passe
                            </button>
                        </form>

                        <!-- Section suppression de compte -->
                        <div
                            class="mt-12 p-6 bg-red-50 border border-red-200 rounded-lg"
                        >
                            <h3 class="text-lg font-bold text-red-800 mb-2">
                                Zone dangereuse
                            </h3>
                            <p class="text-red-600 mb-4">
                                La suppression de votre compte est irr√©versible.
                            </p>
                            <button
                                onclick="deleteAccount()"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-2 rounded-lg transition"
                            >
                                üóëÔ∏è Supprimer mon compte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    import pb from "../lib/pocketbase.js";
    import { isLoggedIn, getCurrentUser, logout } from "../js/auth.js";

    let currentUser = null;

    document.addEventListener("DOMContentLoaded", async () => {
        await initProfile();
    });

    // Initialiser la page profil
    async function initProfile() {
        const loadingState = document.getElementById("loadingState");
        const notLoggedInState = document.getElementById("notLoggedInState");
        const mainContent = document.getElementById("mainContent");

        try {
            // V√©rifier la connexion
            if (!isLoggedIn()) {
                loadingState.classList.add("hidden");
                notLoggedInState.classList.remove("hidden");
                return;
            }

            currentUser = getCurrentUser();

            // Charger le profil
            await loadUserProfile();
            await loadUserStats();

            // Initialiser les √©v√©nements
            initTabs();
            initAvatarUpload();
            initForms();

            // Afficher le contenu
            loadingState.classList.add("hidden");
            mainContent.classList.remove("hidden");
        } catch (error) {
            console.error("Erreur lors de l'initialisation du profil:", error);
            loadingState.classList.add("hidden");
            showError("Erreur lors du chargement du profil");
        }
    }

    // Charger les informations utilisateur
    async function loadUserProfile() {
        try {
            // R√©cup√©rer les donn√©es utilisateur √† jour
            const user = await pb.collection("users").getOne(currentUser.id);
            currentUser = user;

            // Mettre √† jour l'affichage
            document.getElementById("userName").textContent =
                user.pseudo || "Utilisateur";
            document.getElementById("userEmail").textContent = user.email;

            // Avatar
            const avatarImg = document.getElementById("profileAvatar");
            if (user.avatar) {
                avatarImg.src = `http://127.0.0.1:8090/api/files/users/${user.id}/${user.avatar}`;
            } else {
                avatarImg.src = "/placeholder.svg";
            }

            // Statut Cookup
            const cookupStatus = document.getElementById("cookupStatus");
            const cookupCTA = document.getElementById("cookupCTA");

            // Gestion de l'affichage de l'onglet r√©gime selon le statut Cookup
            const regimeTabBtn = document.getElementById("regimeTabBtn");
            // L'onglet reste toujours visible
            if (regimeTabBtn) {
                regimeTabBtn.classList.remove("hidden");
            }

            if (user.cookup) {
                cookupStatus.innerHTML = `
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-yellow-400 to-orange-500 text-white">
                        ‚≠ê Membre Cookup Pass
                    </div>
                `;
                cookupCTA.classList.add("hidden");
            } else {
                cookupStatus.innerHTML = `
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                        üë§ Membre standard
                    </div>
                `;
                cookupCTA.classList.remove("hidden");
            }

            // Remplir le formulaire
            document.getElementById("prenom").value = user.prenom || "";
            document.getElementById("nomFamille").value = user.nomFamille || "";
            document.getElementById("pseudo").value = user.pseudo || "";
            document.getElementById("email").value = user.email || "";

            // Date de cr√©ation
            const memberSince = new Date(user.created).getFullYear();
            document.getElementById("memberSince").textContent = memberSince;

            // Charger les r√©gimes de l'utilisateur
            await loadUserRegimes();
        } catch (error) {
            console.error("Erreur lors du chargement du profil:", error);
            throw error;
        }
    }

    // Charger les statistiques utilisateur
    async function loadUserStats() {
        try {
            // Compter les commentaires
            const comments = await pb.collection("commentaires").getFullList({
                filter: `user = "${currentUser.id}"`,
            });
            document.getElementById("commentCount").textContent =
                comments.length;

            // Compter les favoris
            const favorites = await pb.collection("favoris").getFullList({
                filter: `user = "${currentUser.id}"`,
            });
            document.getElementById("favoriteCount").textContent =
                favorites.length;
        } catch (error) {
            console.error("Erreur lors du chargement des statistiques:", error);
        }
    }

    // Initialiser les onglets
    function initTabs() {
        const tabButtons = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");

        tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const targetTab = button.dataset.tab;

                // D√©sactiver tous les onglets
                tabButtons.forEach((btn) => {
                    btn.classList.remove(
                        "border-yellow-500",
                        "text-yellow-600",
                        "bg-yellow-50",
                    );
                    btn.classList.add("border-transparent", "text-gray-500");
                });

                // Cacher tous les contenus
                tabContents.forEach((content) => {
                    content.classList.add("hidden");
                });

                // Activer l'onglet cliqu√©
                button.classList.remove("border-transparent", "text-gray-500");
                button.classList.add(
                    "border-yellow-500",
                    "text-yellow-600",
                    "bg-yellow-50",
                );

                // Afficher le contenu correspondant
                const targetContent = document.getElementById(
                    targetTab + "Tab",
                );
                if (targetContent) {
                    targetContent.classList.remove("hidden");

                    // V√©rifications sp√©ciales selon l'onglet
                    if (targetTab === "comments") {
                        loadUserComments();
                    } else if (targetTab === "avis") {
                        loadUserAvis();
                    } else if (targetTab === "regime") {
                        // V√©rifier l'acc√®s au r√©gime
                        if (!currentUser?.cookup) {
                            // Masquer le formulaire et afficher le message d'acc√®s refus√©
                            document
                                .getElementById("regimeForm")
                                .classList.add("hidden");
                            document
                                .querySelector("#regimeTab .mt-8")
                                .classList.add("hidden"); // Section informative
                            document
                                .getElementById("regimeAccessDenied")
                                .classList.remove("hidden");
                        } else {
                            // Afficher le formulaire et masquer le message
                            document
                                .getElementById("regimeForm")
                                .classList.remove("hidden");
                            document
                                .querySelector("#regimeTab .mt-8")
                                .classList.remove("hidden"); // Section informative
                            document
                                .getElementById("regimeAccessDenied")
                                .classList.add("hidden");
                        }
                    } else if (targetTab === "subscription") {
                        loadSubscriptionInfo();
                    }
                }
            });
        });
    }

    // Initialiser l'upload d'avatar
    function initAvatarUpload() {
        const changeAvatarBtn = document.getElementById("changeAvatarBtn");
        const avatarInput = document.getElementById("avatarInput");
        const profileAvatar = document.getElementById("profileAvatar");

        changeAvatarBtn.addEventListener("click", () => {
            avatarInput.click();
        });

        avatarInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // V√©rifications
            if (!file.type.startsWith("image/")) {
                showError("Veuillez s√©lectionner une image valide");
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                // 5MB
                showError("L'image ne doit pas d√©passer 5MB");
                return;
            }

            try {
                changeAvatarBtn.textContent = "‚è≥";
                changeAvatarBtn.disabled = true;

                // Cr√©er FormData
                const formData = new FormData();
                formData.append("avatar", file);

                // Mettre √† jour l'avatar
                const updatedUser = await pb
                    .collection("users")
                    .update(currentUser.id, formData);

                // Mettre √† jour l'affichage
                profileAvatar.src = `http://127.0.0.1:8090/api/files/users/${updatedUser.id}/${updatedUser.avatar}`;

                showSuccess("Photo de profil mise √† jour !");

                // D√©clencher l'√©v√©nement pour mettre √† jour le header
                document.dispatchEvent(new CustomEvent("userUpdate"));
            } catch (error) {
                console.error("Erreur lors de l'upload:", error);
                showError("Erreur lors de la mise √† jour de la photo");
            } finally {
                changeAvatarBtn.textContent = "üì∑";
                changeAvatarBtn.disabled = false;
            }
        });
    }

    // Initialiser les formulaires
    function initForms() {
        // Formulaire profil
        const profileForm = document.getElementById("profileForm");
        profileForm.addEventListener("submit", handleProfileUpdate);

        // Formulaire mot de passe
        const passwordForm = document.getElementById("passwordForm");
        passwordForm.addEventListener("submit", handlePasswordChange);

        // CTA Cookup Pass
        const getCookupPass = document.getElementById("getCookupPass");
        getCookupPass?.addEventListener("click", () => {
            // TODO: Rediriger vers la page Cookup Pass
            alert("Redirection vers la page Cookup Pass (√† impl√©menter)");
        });

        // Formulaire r√©gime
        const regimeForm = document.getElementById("regimeForm");
        regimeForm.addEventListener("submit", handleRegimeUpdate);

        // CTA Cookup Pass depuis l'onglet r√©gime
        const getCookupPassFromRegime = document.getElementById(
            "getCookupPassFromRegime",
        );
        getCookupPassFromRegime?.addEventListener("click", () => {
            // TODO: Rediriger vers la page Cookup Pass
            alert("Redirection vers la page Cookup Pass (√† impl√©menter)");
        });
    }

    // G√©rer la mise √† jour du profil
    async function handleProfileUpdate(e) {
        e.preventDefault();

        const profileMessage = document.getElementById("profileMessage");
        const submitBtn = e.target.querySelector('button[type="submit"]');

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = "‚è≥ Sauvegarde...";

            const formData = new FormData(e.target);
            const updateData = {
                prenom: formData.get("prenom"),
                nomFamille: formData.get("nomFamille"),
                pseudo: formData.get("pseudo"),
                email: formData.get("email"),
            };

            await pb.collection("users").update(currentUser.id, updateData);

            showSuccess("Profil mis √† jour avec succ√®s !", profileMessage);

            // Recharger les donn√©es
            await loadUserProfile();

            // D√©clencher l'√©v√©nement pour mettre √† jour le header
            document.dispatchEvent(new CustomEvent("userUpdate"));
        } catch (error) {
            console.error("Erreur lors de la mise √† jour:", error);
            showError(
                "Erreur lors de la mise √† jour du profil",
                profileMessage,
            );
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "üíæ Sauvegarder les modifications";
        }
    }

    // G√©rer le changement de mot de passe
    async function handlePasswordChange(e) {
        e.preventDefault();

        const passwordMessage = document.getElementById("passwordMessage");
        const submitBtn = e.target.querySelector('button[type="submit"]');

        try {
            const formData = new FormData(e.target);
            const currentPassword = formData.get("currentPassword");
            const newPassword = formData.get("newPassword");
            const confirmPassword = formData.get("confirmPassword");

            // V√©rifications
            if (!currentPassword || !newPassword || !confirmPassword) {
                throw new Error("Tous les champs sont obligatoires");
            }

            if (newPassword !== confirmPassword) {
                throw new Error(
                    "Les nouveaux mots de passe ne correspondent pas",
                );
            }

            if (newPassword.length < 8) {
                throw new Error(
                    "Le nouveau mot de passe doit contenir au moins 8 caract√®res",
                );
            }

            submitBtn.disabled = true;
            submitBtn.textContent = "‚è≥ Modification...";

            // Changer le mot de passe
            await pb.collection("users").update(currentUser.id, {
                oldPassword: currentPassword,
                password: newPassword,
                passwordConfirm: newPassword,
            });

            showSuccess("Mot de passe modifi√© avec succ√®s !", passwordMessage);

            // R√©initialiser le formulaire
            e.target.reset();
        } catch (error) {
            console.error("Erreur lors du changement de mot de passe:", error);
            showError(
                error.message || "Erreur lors du changement de mot de passe",
                passwordMessage,
            );
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "üîí Changer le mot de passe";
        }
    }

    // Charger les commentaires de l'utilisateur
    async function loadUserComments() {
        const commentsLoading = document.getElementById("commentsLoading");
        const userCommentsList = document.getElementById("userCommentsList");
        const noUserComments = document.getElementById("noUserComments");

        try {
            commentsLoading.classList.remove("hidden");
            userCommentsList.classList.add("hidden");
            noUserComments.classList.add("hidden");

            const comments = await pb.collection("commentaires").getFullList({
                filter: `user = "${currentUser.id}"`,
                expand: "recette",
                sort: "-created",
            });

            commentsLoading.classList.add("hidden");

            if (comments.length === 0) {
                noUserComments.classList.remove("hidden");
                return;
            }

            userCommentsList.innerHTML = comments
                .map(createUserCommentHTML)
                .join("");
            userCommentsList.classList.remove("hidden");
        } catch (error) {
            console.error("Erreur lors du chargement des commentaires:", error);
            commentsLoading.classList.add("hidden");
            showError("Erreur lors du chargement des commentaires");
        }
    }

    // Charger les avis de l'utilisateur
    async function loadUserAvis() {
        const avisLoading = document.getElementById("avisLoading");
        const userAvisList = document.getElementById("userAvisList");
        const noUserAvis = document.getElementById("noUserAvis");

        try {
            avisLoading.classList.remove("hidden");
            userAvisList.classList.add("hidden");
            noUserAvis.classList.add("hidden");

            const avis = await pb.collection("avis_site").getFullList({
                filter: `user = "${currentUser.id}"`,
                sort: "-created",
            });

            avisLoading.classList.add("hidden");

            if (avis.length === 0) {
                noUserAvis.classList.remove("hidden");
                return;
            }

            userAvisList.innerHTML = avis.map(createUserAvisHTML).join("");
            userAvisList.classList.remove("hidden");
        } catch (error) {
            console.error("Erreur lors du chargement des avis:", error);
            avisLoading.classList.add("hidden");
            showError("Erreur lors du chargement des avis");
        }
    }

    // Cr√©er le HTML d'un commentaire utilisateur
    function createUserCommentHTML(comment) {
        const recette = comment.expand?.recette;
        const recetteName = recette?.nom || "Recette supprim√©e";
        const recetteLink = recette ? `/recette-plat/${recette.id}` : "#";

        const createdDate = new Date(comment.created).toLocaleDateString(
            "fr-FR",
            {
                year: "numeric",
                month: "long",
                day: "numeric",
            },
        );

        const stars = comment.note ? "‚≠ê".repeat(comment.note) : "";

        // G√©n√©rer l'avatar
        let avatarHTML = "";
        if (currentUser?.avatar) {
            const avatarUrl = `http://127.0.0.1:8090/api/files/users/${currentUser.id}/${currentUser.avatar}`;
            avatarHTML = `<img src="${avatarUrl}" alt="Mon avatar" class="w-12 h-12 rounded-full object-cover" />`;
        } else {
            const userName =
                currentUser?.name ||
                `${currentUser?.prenom || ""} ${currentUser?.pseudo || ""}`.trim() ||
                "Utilisateur";
            const userInitials = userName
                .split(" ")
                .map((n) => n[0])
                .join("")
                .toUpperCase()
                .slice(0, 2);
            avatarHTML = `<div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold">${userInitials}</div>`;
        }

        return `
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="flex items-start space-x-4">
                    <!-- Avatar -->
                    ${avatarHTML}
                    
                    <!-- Contenu -->
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg">
                                    <a href="${recetteLink}" class="text-yellow-600 hover:text-yellow-800 transition">
                                        ${recetteName}
                                    </a>
                                </h4>
                                <p class="text-sm text-gray-500">${createdDate}</p>
                            </div>
                            ${stars ? `<div class="text-lg">${stars}</div>` : ""}
                        </div>
                        
                        <p class="text-gray-800 leading-relaxed">${comment.contenu}</p>
                        
                        <div class="mt-4 flex gap-2">
                            ${
                                recette
                                    ? `
                                <a href="${recetteLink}" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium transition">
                                    üëÅÔ∏è Voir la recette
                                </a>
                            `
                                    : ""
                            }
                            <button 
                                onclick="deleteUserComment('${comment.id}')"
                                class="text-red-600 hover:text-red-800 text-sm font-medium transition"
                            >
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Cr√©er le HTML d'un avis utilisateur
    function createUserAvisHTML(avis) {
        const createdDate = new Date(avis.created).toLocaleDateString("fr-FR", {
            year: "numeric",
            month: "long",
            day: "numeric",
        });

        const stars = avis.note ? "‚≠ê".repeat(avis.note) : "";

        // G√©n√©rer l'avatar
        let avatarHTML = "";
        if (currentUser?.avatar) {
            const avatarUrl = `http://127.0.0.1:8090/api/files/users/${currentUser.id}/${currentUser.avatar}`;
            avatarHTML = `<img src="${avatarUrl}" alt="Mon avatar" class="w-12 h-12 rounded-full object-cover" />`;
        } else {
            const userName = currentUser?.pseudo || "Utilisateur";
            const userInitials = userName.substring(0, 2).toUpperCase();
            avatarHTML = `<div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold">${userInitials}</div>`;
        }

        // Cat√©gories
        const categories = Array.isArray(avis.categories)
            ? avis.categories
            : [];
        const categoriesHTML =
            categories.length > 0
                ? `<div class="flex flex-wrap gap-1 mb-3">
                ${categories.map((cat) => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${getCategoryIcon(cat)} ${cat}</span>`).join("")}
               </div>`
                : "";

        return `
            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="flex items-start space-x-4">
                    <!-- Avatar -->
                    ${avatarHTML}
                    
                    <!-- Contenu -->
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg">Avis sur Cookit-UP</h4>
                                <p class="text-sm text-gray-500">${createdDate}</p>
                                <div class="flex items-center mt-1">
                                    ${stars ? `<span class="text-lg mr-2">${stars}</span>` : ""}
                                    ${
                                        avis.allow_publication
                                            ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">üì¢ Public</span>'
                                            : '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">üîí Priv√©</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        ${categoriesHTML}
                        
                        <p class="text-gray-800 leading-relaxed mb-4">${avis.comment}</p>
                        
                        ${
                            avis.suggestions
                                ? `
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded mb-4">
                                <h5 class="font-medium text-blue-800 mb-1">üí° Mes suggestions</h5>
                                <p class="text-blue-700 text-sm">${avis.suggestions}</p>
                            </div>
                        `
                                : ""
                        }
                        
                        <div class="flex gap-2">
                            <a href="/avis-site" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium transition">
                                ‚úèÔ∏è Modifier
                            </a>
                            <button 
                                onclick="deleteUserAvis('${avis.id}')"
                                class="text-red-600 hover:text-red-800 text-sm font-medium transition"
                            >
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Obtenir l'ic√¥ne d'une cat√©gorie
    function getCategoryIcon(category) {
        const icons = {
            recettes: "üçΩÔ∏è",
            interface: "üé®",
            partenaires: "üè™",
            fonctionnalites: "‚öôÔ∏è",
            support: "üÜò",
            general: "üåü",
        };
        return icons[category] || "üìù";
    }

    // Supprimer un commentaire utilisateur
    window.deleteUserComment = async function (commentId) {
        if (!confirm("√ätes-vous s√ªr de vouloir supprimer ce commentaire ?")) {
            return;
        }

        try {
            await pb.collection("commentaires").delete(commentId);
            await loadUserComments();
            await loadUserStats();
            showSuccess("Commentaire supprim√© üóëÔ∏è");
        } catch (error) {
            console.error("Erreur lors de la suppression:", error);
            showError("Erreur lors de la suppression du commentaire");
        }
    };

    // Supprimer un avis utilisateur
    window.deleteUserAvis = async function (avisId) {
        if (!confirm("√ätes-vous s√ªr de vouloir supprimer cet avis ?")) {
            return;
        }

        try {
            await pb.collection("avis_site").delete(avisId);
            await loadUserAvis();
            showSuccess("Avis supprim√© üóëÔ∏è");
        } catch (error) {
            console.error("Erreur lors de la suppression:", error);
            showError("Erreur lors de la suppression de l'avis");
        }
    };

    // Supprimer le compte
    window.deleteAccount = async function () {
        const confirmation = prompt(
            'Pour confirmer la suppression de votre compte, tapez "SUPPRIMER" :',
        );

        if (confirmation !== "SUPPRIMER") {
            return;
        }

        try {
            await pb.collection("users").delete(currentUser.id);
            logout();
            window.location.href = "/";
        } catch (error) {
            console.error("Erreur lors de la suppression du compte:", error);
            showError("Erreur lors de la suppression du compte");
        }
    };

    // Fonctions utilitaires
    function showSuccess(message, container = null) {
        const element = container || createNotification();
        element.className =
            "p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg";
        element.textContent = message;
        element.classList.remove("hidden");

        if (!container) {
            setTimeout(() => element.remove(), 3000);
        }
    }

    function showError(message, container = null) {
        const element = container || createNotification();
        element.className =
            "p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg";
        element.textContent = message;
        element.classList.remove("hidden");

        if (!container) {
            setTimeout(() => element.remove(), 3000);
        }
    }

    function createNotification() {
        const notification = document.createElement("div");
        notification.className = "fixed top-4 right-4 z-50 max-w-sm";
        document.body.appendChild(notification);
        return notification;
    }

    // Charger les r√©gimes de l'utilisateur
    async function loadUserRegimes() {
        try {
            // R√©cup√©rer les donn√©es utilisateur √† jour
            const user = await pb.collection("users").getOne(currentUser.id);

            // D√©cocher toutes les cases
            const checkboxes = document.querySelectorAll(
                'input[name="regime"]',
            );
            checkboxes.forEach((checkbox) => {
                checkbox.checked = false;
            });

            // Cocher les r√©gimes de l'utilisateur
            if (user.regime && Array.isArray(user.regime)) {
                user.regime.forEach((regime) => {
                    const checkbox = document.querySelector(
                        `input[name="regime"][value="${regime}"]`,
                    );
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }

            console.log("‚úÖ R√©gimes charg√©s:", user.regime);
        } catch (error) {
            console.error("Erreur lors du chargement des r√©gimes:", error);
        }
    }

    // G√©rer la mise √† jour des r√©gimes
    async function handleRegimeUpdate(e) {
        e.preventDefault();

        const regimeMessage = document.getElementById("regimeMessage");
        const submitBtn = e.target.querySelector('button[type="submit"]');

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = "‚è≥ Sauvegarde...";

            // R√©cup√©rer les r√©gimes s√©lectionn√©s
            const formData = new FormData(e.target);
            const selectedRegimes = formData.getAll("regime");

            console.log("üìù R√©gimes s√©lectionn√©s:", selectedRegimes);

            // Mettre √† jour dans PocketBase
            await pb.collection("users").update(currentUser.id, {
                regime: selectedRegimes,
            });

            showSuccess(
                "Pr√©f√©rences alimentaires mises √† jour avec succ√®s ! ü•ó",
                regimeMessage,
            );

            // D√©clencher l'√©v√©nement pour mettre √† jour le header
            document.dispatchEvent(new CustomEvent("userUpdate"));
        } catch (error) {
            console.error("Erreur lors de la mise √† jour des r√©gimes:", error);
            showError(
                "Erreur lors de la mise √† jour des pr√©f√©rences",
                regimeMessage,
            );
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "ü•ó Sauvegarder mes pr√©f√©rences";
        }
    }

    // Charger les informations d'abonnement
    async function loadSubscriptionInfo() {
        const subscriptionLoading = document.getElementById(
            "subscriptionLoading",
        );
        const noSubscription = document.getElementById("noSubscription");
        const activeSubscription =
            document.getElementById("activeSubscription");

        try {
            subscriptionLoading.classList.remove("hidden");
            noSubscription.classList.add("hidden");
            activeSubscription.classList.add("hidden");

            // Simuler un d√©lai de chargement
            await new Promise((resolve) => setTimeout(resolve, 1000));

            subscriptionLoading.classList.add("hidden");

            // V√©rifier si l'utilisateur a un abonnement actif (bas√© sur le champ cookup)
            if (currentUser?.cookup) {
                // Simuler les donn√©es d'abonnement
                const subscriptionData = getSimulatedSubscriptionData();
                displaySubscriptionInfo(subscriptionData);
                activeSubscription.classList.remove("hidden");
            } else {
                noSubscription.classList.remove("hidden");
            }
        } catch (error) {
            console.error("Erreur lors du chargement de l'abonnement:", error);
            subscriptionLoading.classList.add("hidden");
            showError(
                "Erreur lors du chargement des informations d'abonnement",
            );
        }
    }

    // Simuler les donn√©es d'abonnement
    function getSimulatedSubscriptionData() {
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 2); // Abonnement depuis 2 mois

        const nextBilling = new Date();
        nextBilling.setMonth(nextBilling.getMonth() + 1); // Prochaine facturation dans 1 mois

        return {
            type: "monthly",
            price: "5,99‚Ç¨",
            startDate: startDate.toLocaleDateString("fr-FR"),
            nextBilling: nextBilling.toLocaleDateString("fr-FR"),
            status: "active",
            autoRenewal: true,
        };
    }

    // Afficher les informations d'abonnement
    function displaySubscriptionInfo(data) {
        document.getElementById("subscriptionType").textContent =
            data.type === "monthly"
                ? "Abonnement mensuel"
                : "Abonnement annuel";
        document.getElementById("subscriptionPrice").textContent = data.price;
        document.getElementById("subscriptionStartDate").textContent =
            data.startDate;
        document.getElementById("nextBillingDate").textContent =
            data.nextBilling;
        document.getElementById("autoRenewal").textContent = data.autoRenewal
            ? "Activ√©"
            : "D√©sactiv√©";
    }

    // Am√©liorer l'abonnement
    window.upgradeSubscription = function () {
        if (
            confirm(
                "Voulez-vous passer √† l'abonnement annuel et √©conomiser 26% ?",
            )
        ) {
            // Simuler la mise √† niveau
            showSuccess(
                "Mise √† niveau programm√©e ! Votre abonnement passera en annuel lors du prochain renouvellement.",
            );

            // Mettre √† jour l'affichage
            setTimeout(() => {
                document.getElementById("subscriptionType").textContent =
                    "Abonnement annuel (√† partir du prochain cycle)";
            }, 1000);
        }
    };

    // R√©silier l'abonnement
    window.cancelSubscription = function () {
        const confirmation = prompt(
            'Pour confirmer la r√©siliation de votre abonnement, tapez "RESILIER" :',
        );

        if (confirmation === "RESILIER") {
            // Simuler la r√©siliation
            showSuccess(
                "Abonnement r√©sili√©. Vous conserverez l'acc√®s jusqu'√† la fin de votre p√©riode de facturation actuelle.",
            );

            // Mettre √† jour le statut utilisateur
            setTimeout(async () => {
                try {
                    // Mettre √† jour le statut cookup √† false
                    await pb.collection("users").update(currentUser.id, {
                        cookup: false,
                    });

                    // Recharger le profil
                    await loadUserProfile();

                    // D√©clencher l'√©v√©nement pour mettre √† jour le header
                    document.dispatchEvent(new CustomEvent("userUpdate"));

                    // Recharger l'onglet abonnement
                    loadSubscriptionInfo();
                } catch (error) {
                    console.error("Erreur lors de la r√©siliation:", error);
                    showError("Erreur lors de la r√©siliation de l'abonnement");
                }
            }, 1000);
        }
    };
</script>
